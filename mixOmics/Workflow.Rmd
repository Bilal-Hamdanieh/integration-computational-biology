---
title: "mixOmics"
author: "Bilal Hamdanieh"
date: "`r Sys.Date()`"
output: html_document
---

# Install Packages

```{r}
## INSTALL MIXOMICS
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("mixOmics")

## INSTALL DEVTOOLS
# install.packages("devtools")


## LOAD PACKAGES
library(devtools)
library(mixOmics)
```

---

# Multi-block Discriminant Analysis with DIABLO - mixOmics


> DIABLO is our new framework in mixOmics that extends PLS for multiple data sets integration and PLS-discriminant analysis. The acronyms stands for Data Integration Analysis for Biomarker discovery using a Latent cOmponents (Singh et al. 2017).

---

# Biological question
I would like to identify a highly correlated multi-omics signature discriminating known groups of samples.

> The breast.TCGA study

Human breast cancer is a heterogeneous disease in terms of molecular alterations, cellular composition, and clinical outcome. Breast tumours can be classified into several subtypes, according to levels of mRNA expression [Sorlie et al. (2001). Here we consider a subset of data generated by The Cancer Genome Atlas Network (Cancer Genome Atlas Network and others 2012). For the package, data were normalised and drastically prefiltered for illustrative purposes but DIABLO can handle larger data sets, see (Florian Rohart et al. 2017) Table 2. The data were divided into a training set with a subset of 150 samples from the mRNA, miRNA and proteomics data, and a test set including 70 samples, but only with mRNA and miRNA data (proteomics missing). The aim of this integrative analysis is to identify a highly correlated multi-omics signature discriminating the breast cancer subtypes Basal, Her2 and LumA.

* The breast.TCGA is a list containing training and test sets of omics data data.train and data.test which both include:

* miRNA: a data frame with 150 (70) rows and 184 columns in the training (test) data set for the miRNA expression levels.

* mRNA: a data frame with 150 (70) rows and 520 columns in the training (test) data set for the mRNA expression levels.

* protein: a data frame with 150 rows and 142 columns in the training data set only for the protein abundance.

* subtype: a factor indicating the breast cancer subtypes in the training (length of 150) and test (length of 70) sets.

* More details can be found in ?breast.TCGA.

> To illustrate DIABLO, we will integrate the expression levels of miRNA, mRNA and the abundance of proteins while discriminating the subtypes of breast cancer, then predict the subtypes of the test samples in the test set.

---

# Principle of DIABLO
The core DIABLO method extends Generalised Canonical Correlation Analysis (Tenenhaus and Tenenhaus 2011), which contrary to what its name suggests, generalises PLS for multiple matching datasets, and the sparse sGCCA method (Tenenhaus et al. 2014). Starting from the R package RGCCA, we extended these methods for different types of analyses, including unsupervised N-integration (block.pls, block.spls) and supervised analyses (block.plsda, block.splsda).

The aim of N-integration with our sparse methods is to identify correlated (or co-expressed) variables measured on heterogeneous data sets which also explain the categorical outcome of interest (supervised analysis). The multiple data integration task is not trivial, as the analysis can be strongly affected by the variation between manufacturers or omics technological platforms despite being measured on the same biological samples. Before you embark on data integration, we strongly suggest individual or paired analyses with sPLS-DA and PLS to first understand the major sources of variation in each data set and to guide the integration process.

More methodological details can be found in (Singh et al. 2017).

# Inputs and outputs

* We consider as input a list X of data frames with n rows (the number of samples) and different number of variations in each data frame. Y is a factor vector of length n that indicates the class of each sample. Internally and similar to PLS-DA in Chapter 5 it will be coded as a dummy matrix.

> DIABLO main outputs are:

* A set of components, also called latent variables associated to each data set. There are as many components as the chosen dimension of DIABLO.

* A set of loading vectors, which are coefficients assigned to each variable to define each component. Those coefficients indicate the importance of each variable in DIABLO. Importantly, each loading vector is associated to a particular component. Loading vectors are obtained so that the covariance between a linear combination of the variables from X (the X-component) and from Y (the Y-component) is maximised.

* A list of selected variables from each data set and associated to each component if sparse DIABLO is applied.

# Set up the data
We first set up the input data as a list of data frames X expression matrix and Y as a factor indicating the class membership of each sample. Each data frame in X should be named consistently to match with the keepX parameter.

We check that the dimensions are correct and match. We then set up arbitrarily the number of variables keepX that we wish to select in each data set and each component.

```{r}
library(mixOmics)
data(breast.TCGA)
# extract training data and name each data frame
X <- list(mRNA = breast.TCGA$data.train$mrna, 
          miRNA = breast.TCGA$data.train$mirna, 
          protein = breast.TCGA$data.train$protein)
Y <- breast.TCGA$data.train$subtype
summary(Y)

list.keepX <- list(mRNA = c(16, 17), miRNA = c(18,5), protein = c(5, 5))
```


# Quick start
```{r}
MyResult.diablo <- block.splsda(X, Y, keepX=list.keepX)
plotIndiv(MyResult.diablo)
plotVar(MyResult.diablo)
```


```{r}
MyResult.diablo2 <- block.plsda(X, Y)

plotIndiv(MyResult.diablo, 
          ind.names = FALSE, 
          legend=TRUE, cex=c(1,2,3),
          title = 'BRCA with DIABLO')
          
          
plotVar(MyResult.diablo, var.names = c(FALSE, FALSE, TRUE),
        legend=TRUE, pch=c(16,16,1))

plotDiablo(MyResult.diablo, ncomp = 1)

circosPlot(MyResult.diablo, cutoff=0.7)



cimDiablo(MyResult.diablo, color.blocks = c('darkorchid', 'brown1', 'lightgreen'), comp = 1, margin=c(8,20), legend.position = "right")


plotLoadings(MyResult.diablo, comp = 2, contrib = "max")


network(MyResult.diablo, blocks = c(1,2,3),
        color.node = c('darkorchid', 'brown1', 'lightgreen'), 
        cutoff = 0.6, save = 'jpeg', name.save = 'DIABLOnetwork')
        
        
        
set.seed(123) # for reproducibility in this vignette
MyPerf.diablo <- perf(MyResult.diablo, validation = 'Mfold', folds = 5, 
                   nrepeat = 10, 
                   dist = 'centroids.dist')
                   
Myauc.diablo <- auroc(MyResult.diablo, roc.block = "miRNA", roc.comp = 2)


# prepare test set data: here one block (proteins) is missing
X.test <- list(mRNA = breast.TCGA$data.test$mrna, 
                      miRNA = breast.TCGA$data.test$mirna)

Mypredict.diablo <- predict(MyResult.diablo, newdata = X.test)
# the warning message will inform us that one block is missing
# Mypredict.diablo # list the different outputs

confusion.mat <- get.confusion_matrix(
                truth = breast.TCGA$data.test$subtype, 
                predicted = Mypredict.diablo$MajorityVote$centroids.dist[,2])
kable(confusion.mat)


get.BER(confusion.mat)
```